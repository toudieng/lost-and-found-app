{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Preuve de restitution - {{ restitution.id }}</title>
    <style>
        body { font-family: 'DejaVu Sans', sans-serif; margin: 2cm; color: #333; }

        /* Header */
        .header-table { width: 100%; border-bottom: 2px solid #003366; margin-bottom: 20px; padding-bottom: 10px; border-collapse: collapse; }
        .header-table td { vertical-align: middle; }
        .header-table td.left { text-align: left; width: 20%; }
        .header-table td.center { text-align: center; width: 60%; }
        .header-table td.right { text-align: right; width: 20%; }
        .header-table img { height: 80px; width: auto; }

        /* Title */
        .title { text-align: center; color: #003366; margin-bottom: 25px; }

        /* Sections */
        .section { margin-bottom: 20px; }
        .section h4 { color: #003366; margin-bottom: 8px; border-bottom: 2px solid #C8A048; display: inline-block; padding-bottom: 2px; }
        .section p { margin: 0.2rem 0; font-size: 0.95rem; }
        .section strong { color: #C8A048; }

        /* Trouveurs */
        .trouveurs { padding-left: 1rem; }

        /* QR code */
        .qr { text-align: right; margin-top: 30px; }
        .qr img { height: 100px; }

        /* Signature */
        .signature { margin-top: 40px; text-align: right; font-style: italic; }

        /* Footer */
        .footer { position: fixed; bottom: 1cm; text-align: center; font-size: 10px; color: #888; width: 100%; }

        /* Highlight objet important */
        .highlight { color: #C8A048; font-weight: 600; }
    </style>
</head>
<body>

    <!-- Header -->
    <table class="header-table">
        <tr>
            <td class="left"><img src="{% static 'frontend/images/logo_senegal.png' %}" alt="Logo Sénégal"></td>
            <td class="center">
                <h2>République du Sénégal</h2>
                <p><strong>Police Nationale</strong> — Preuve de restitution d’objet</p>
            </td>
            <td class="right"><img src="{% static 'frontend/images/logo_police.png' %}" alt="Logo Police"></td>
        </tr>
    </table>

    <!-- Titre -->
    <div class="title">
        <h3>Attestation de Restitution N°{{ restitution.id }}</h3>
        <p>Date : {{ restitution.date_restitution|date:"d/m/Y" }} — Heure : {{ restitution.heure_restitution|time:"H:i" }}</p>
    </div>

    <!-- Objet restitué -->
    <div class="section">
        <h4>Objet Restitué</h4>
        <p><strong class="highlight">{{ restitution.objet.nom|default:"Non renseigné" }}</strong></p>
        <p>{{ restitution.objet.description|default:"Aucune description disponible" }}</p>
    </div>

    <!-- Réclamant -->
    <div class="section">
        <h4>TROUVEUR</h4>
        {% if reclamant_principal %}
            <p>Nom : <strong>{{ reclamant_principal.username }}</strong></p>
            <p>Email : {{ reclamant_principal.email|default:"Non renseigné" }}</p>
            <p>Téléphone : {{ reclamant_principal.telephone|default:"Non renseigné" }}</p>
        {% else %}
            <p>Nom : <strong>Non renseigné</strong></p>
            <p>Email : Non renseigné</p>
            <p>Téléphone : Non renseigné</p>
        {% endif %}
    </div>

    <!-- Citoyen (destinataire) -->
    <div class="section">
        <h4>RECLAMANT</h4>
        <p>Nom : <strong>{{ restitution.citoyen.username|default:"Non renseigné" }}</strong></p>
        <p>Email : {{ restitution.citoyen.email|default:"Non renseigné" }}</p>
    </div>

    <!-- Trouveurs -->
    <div class="section">
        <h4>Trouveurs</h4>
        {% if restitution.objet.declaration_set.exists %}
            <ul class="trouveurs">
                {% for declaration in restitution.objet.declaration_set.all %}
                    {% for user in declaration.trouve_par.all %}
                        <li>{{ user.username }} | Email: {{ user.email|default:"-" }} | Téléphone: {{ user.telephone|default:"-" }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">Aucun trouveur enregistré</p>
        {% endif %}
    </div>

    <!-- Policier -->
    <div class="section">
        <h4>Policier</h4>
        {% if restitution.restitue_par %}
            <p>Nom : <strong>{{ restitution.restitue_par.username }}</strong></p>
            <p>Email : {{ restitution.restitue_par.email|default:"Non renseigné" }}</p>
        {% elif restitution.policier %}
            <p>Nom : <strong>{{ restitution.policier.username }}</strong></p>
            <p>Email : {{ restitution.policier.email|default:"Non renseigné" }}</p>
        {% else %}
            <p>Nom : <strong>Non renseigné</strong></p>
            <p>Email : Non renseigné</p>
        {% endif %}
    </div>

    <!-- Commissariat -->
    <div class="section">
        <h4>Commissariat</h4>
        {% if restitution.commissariat %}
            <p>{{ restitution.commissariat.nom|default:"Non renseigné" }}</p>
            <p>{{ restitution.commissariat.adresse|default:"Adresse non renseignée" }}</p>
        {% else %}
            <p>Commissariat non renseigné</p>
            <p>Adresse non renseignée</p>
        {% endif %}
    </div>

    <!-- QR Code -->
    {% if qr_code %}
    <div class="qr">
        <p><strong>QR Code de vérification :</strong></p>
        <img src="data:image/png;base64,{{ qr_code|safe }}" alt="QR Code">
    </div>
    {% endif %}

    <!-- Signature -->
    <div class="signature">
        <p>Signé par : 
            {% if restitution.restitue_par %}{{ restitution.restitue_par.username }}
            {% elif restitution.policier %}{{ restitution.policier.username }}
            {% else %}Non renseigné
            {% endif %}
        </p>
        <p>Fait à {{ restitution.commissariat.nom|default:"Lieu non précisé" }}, le {{ restitution.date_restitution|date:"d/m/Y" }}</p>
    </div>

    <!-- Footer -->
    <div class="footer">
        Document généré automatiquement par le système de gestion des objets perdus et retrouvés © {{ now|date:"Y" }}
    </div>

</body>
</html>
