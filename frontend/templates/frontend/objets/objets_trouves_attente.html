{% extends "frontend/policier/base_policier.html" %}

{% block title %}Objets Retrouv√©s en Attente{% endblock %}

{% block extra_css %}
<style>
/* Highlight des nouvelles restitutions */
.card.new-restitution {
    animation: highlight 2s ease-in-out 1;
    border: 2px solid #ffc107;
}

@keyframes highlight {
    0% { background-color: #fffbe6; }
    50% { background-color: #fff3cd; }
    100% { background-color: #fffbe6; }
}

.badge-new {
    background-color: #ffc107;
    color: #343a40;
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="fw-bold mb-4 text-primary">üì¶ Objets retrouv√©s (en attente)</h2>

    <div class="row g-3">
        {% for restitution in restitutions %}
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm border-0 h-100 {% if not restitution.statut == 'effectuee' %}new-restitution{% endif %}">
                    <!-- Image de l'objet -->
                    {% if restitution.objet.image %}
                        <img src="{{ restitution.objet.image.url }}" class="card-img-top" alt="{{ restitution.objet.nom }}" style="height:200px; object-fit:cover; border-radius:0.5rem 0.5rem 0 0;">
                    {% endif %}

                    <div class="card-body">
                        <!-- Nom de l'objet -->
                        <h5 class="card-title fw-bold text-dark">
                            {{ restitution.objet.nom }}
                            <span class="badge bg-warning text-dark ms-1">En attente</span>
                            {% if not restitution.statut == 'effectuee' %}
                                <span class="badge badge-new ms-1">Nouveau</span>
                            {% endif %}
                        </h5>

                        <!-- D√©clar√© par -->
                        <p class="mb-1 text-muted">
                            üôã <strong>D√©clar√© par :</strong> 
                            {% if restitution.citoyen %}
                                {{ restitution.citoyen.username }}
                                {% if restitution.citoyen.email %} ({{ restitution.citoyen.email }}){% endif %}
                            {% else %}
                                Non pr√©cis√©
                            {% endif %}
                        </p>

                        <!-- Commissariat -->
                        <p class="mb-2 text-muted">
                            üìç <strong>Commissariat :</strong> 
                            {% if restitution.commissariat %}
                                {{ restitution.commissariat.nom }}
                            {% else %}
                                Non pr√©cis√©
                            {% endif %}
                        </p>

                        <!-- Utilisateurs qui ont trouv√© -->
                        {% for declaration in restitution.objet.declarations_trouvees.all %}
                            {% if declaration.trouve_par.exists %}
                                <span class="badge bg-info text-dark mb-1 d-block">
                                    üìå Trouv√© par: 
                                    {% for user in declaration.trouve_par.all %}
                                        {{ user.username }}
                                        {% if user.email %} ({{ user.email }}){% endif %}
                                        {% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </span>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Boutons action -->
                    <div class="card-footer bg-light text-end">
                        <form method="POST" action="{% url 'marquer_restitue' restitution.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-success">
                                ‚úÖ Marquer restitu√©
                            </button>
                        </form>

                        <form method="POST" action="{% url 'annuler_restitution' restitution.id %}" class="d-inline ms-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">
                                ‚ùå Annuler restitution
                            </button>
                        </form>

                        <a href="{% url 'preuve_restitution_pdf' restitution.id %}" target="_blank" class="btn btn-sm btn-primary ms-2">
                            üìÑ Preuve PDF
                        </a>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <div class="alert alert-info text-center">
                    Aucun objet retrouv√© en attente de restitution.
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
